<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Smart Letter Drafter - AGMHSS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js"></script>
    
    <!-- pdfmake libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/vfs_fonts.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tinos:wght@400;700&display=swap');
        .paper-font { font-family: 'Tinos', serif; }
        
        #letter-preview { 
            width: 210mm; 
            height: 297mm; 
            position: relative; 
            background-color: white;
            margin: 20px auto;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        #bgTemplate {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: stretch;
            z-index: 0;
        }

        #contentArea { 
            position: relative;
            z-index: 10;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        @media print { 
            .no-print { display: none; } 
            body { margin: 0; background: white; }
            #letter-preview { margin: 0; box-shadow: none; }
        }
    </style>
</head>
<body class="bg-slate-300 min-h-screen pb-10">

<div class="no-print bg-slate-900 text-white p-4 mb-6 shadow-md flex justify-between items-center px-10">
    <h1 class="text-xl font-bold tracking-tight">AI Letter Pad SPA</h1>
    <div class="text-xs uppercase tracking-widest text-slate-400 font-semibold">AGMHSS IT Department</div>
</div>

<div class="max-w-[1400px] mx-auto px-4 grid grid-cols-1 lg:grid-cols-12 gap-8">
    
    <div class="lg:col-span-4 space-y-4 no-print">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <h2 class="font-bold text-gray-800 mb-4 border-b pb-2">Layout & Tools</h2>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">1. Letterhead Template</label>
                    <input type="file" id="templateInput" accept="image/*" class="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-slate-100 file:text-slate-700 hover:file:bg-slate-200">
                </div>

                <div class="p-4 bg-indigo-50 rounded-xl border border-indigo-100">
                    <label class="block text-xs font-bold text-indigo-900 uppercase mb-1">2. Reply Mode (Scan Letter)</label>
                    <input type="file" id="receivedLetterInput" accept="image/*" class="w-full text-xs mb-2">
                    <button onclick="processOCR()" id="ocrBtn" class="w-full bg-indigo-600 text-white py-2 rounded-lg text-sm font-semibold hover:bg-indigo-700">Scan Reference Letter</button>
                </div>

                <div class="space-y-4 bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <p class="text-[10px] font-black text-slate-400 uppercase">Text Formatting & Margins</p>
                    
                    <div>
                        <div class="flex justify-between text-xs mb-1 font-bold text-indigo-700"><span>Font Size</span><span id="fontVal">12pt</span></div>
                        <input type="range" id="fontSize" min="10" max="24" value="12" class="w-full h-1.5 bg-indigo-200 rounded-lg appearance-none cursor-pointer accent-indigo-600">
                    </div>

                    <hr class="border-slate-200">

                    <div>
                        <div class="flex justify-between text-xs mb-1 font-medium text-slate-600"><span>Top Space</span><span id="topVal">45mm</span></div>
                        <input type="range" id="topMargin" min="10" max="150" value="45" class="w-full h-1.5 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-slate-800">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="flex justify-between text-[10px] mb-1 font-bold"><span>Left</span><span id="leftVal">25mm</span></div>
                            <input type="range" id="leftMargin" min="10" max="80" value="25" class="w-full h-1 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-slate-800">
                        </div>
                        <div>
                            <div class="flex justify-between text-[10px] mb-1 font-bold"><span>Right</span><span id="rightVal">20mm</span></div>
                            <input type="range" id="rightMargin" min="10" max="80" value="20" class="w-full h-1 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-slate-800">
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">4. AI Drafting Context</label>
                    <textarea id="userPrompt" rows="3" class="w-full border border-slate-200 rounded-lg p-3 text-sm focus:ring-2 focus:ring-slate-900 outline-none" placeholder="கடிதத்தின் நோக்கத்தை விளக்கவும்..."></textarea>
                </div>

                <button onclick="generateAIDraft()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold hover:bg-black transition-all shadow-lg">Generate AI Draft</button>
            </div>
        </div>
    </div>

    <div class="lg:col-span-8 flex flex-col items-center">
        <div class="sticky top-6">
            <div id="letter-preview" class="paper-font text-slate-900">
                <img id="bgTemplate" class="hidden" alt="Template Preview">
                
                <div id="contentArea" style="padding: 45mm 20mm 20mm 25mm; font-size: 12pt;">
                    <div class="text-right">
                        <span contenteditable="true" id="currentDate" class="outline-none border-b border-transparent hover:border-slate-300"></span>
                    </div>
                    
                    <div id="salutation" contenteditable="true" class="font-bold outline-none hover:bg-slate-50">மதிப்பிற்குரிய ஐயா/அம்மா,</div>
                    
                    <div id="bodyText" contenteditable="true" class="leading-relaxed text-justify outline-none min-h-[300px] hover:bg-slate-50">
                        உங்கள் டெம்ப்ளேட்டை பதிவேற்றி இடது பக்க கட்டுப்பாடுகளை பயன்படுத்தவும். எழுத்துரு அளவு ஸ்லைடர் உங்கள் பள்ளி லெட்டர்ஹெட்-இல் சரியாக பொருந்த உதவும்.
                    </div>
                    
                    <div id="closing" class="mt-auto pb-10">
                        <div id="thanksField" contenteditable="true" class="outline-none hover:bg-slate-50">நன்றி,</div>
                        <div class="pt-8">
                            <p>உங்கள் உண்மையான,</p>
                            <p id="signatory" contenteditable="true" class="font-bold mt-4 outline-none hover:bg-slate-50 italic">[பெயர்/பதவி]</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <button onclick="downloadPDF()" class="no-print mt-6 w-full bg-rose-600 text-white py-4 rounded-xl font-bold shadow-xl hover:bg-rose-700 flex items-center justify-center gap-3 active:scale-95 transition-all">
                Download Final PDF (தமிழ் சரியாக)
            </button>
        </div>
    </div>
</div>

<script>
// தேதி அமைத்தல்
document.getElementById('currentDate').innerText = new Date().toLocaleDateString('ta-IN', { day: 'numeric', month: 'long', year: 'numeric' });

// Font Size & Margin sliders
const content = document.getElementById('contentArea');
const fontSlider = document.getElementById('fontSize');
const fontValLabel = document.getElementById('fontVal');
fontSlider.oninput = function() {
    const size = this.value + "pt";
    content.style.fontSize = size;
    fontValLabel.innerText = size;
};

const sliders = {
    top: { el: document.getElementById('topMargin'), val: document.getElementById('topVal'), prop: 'paddingTop' },
    left: { el: document.getElementById('leftMargin'), val: document.getElementById('leftVal'), prop: 'paddingLeft' },
    right: { el: document.getElementById('rightMargin'), val: document.getElementById('rightVal'), prop: 'paddingRight' }
};

Object.keys(sliders).forEach(key => {
    sliders[key].el.oninput = function() {
        const val = this.value + "mm";
        content.style[sliders[key].prop] = val;
        sliders[key].val.innerText = val;
    };
});

// Template Image Upload
document.getElementById('templateInput').onchange = function(e) {
    const reader = new FileReader();
    reader.onload = (event) => {
        document.getElementById('bgTemplate').src = event.target.result;
        document.getElementById('bgTemplate').classList.remove('hidden');
    };
    reader.readAsDataURL(e.target.files[0]);
};

// OCR (Tesseract) - தமிழ் ஆதரவு உள்ளது
async function processOCR() {
    const file = document.getElementById('receivedLetterInput').files[0];
    if (!file) return alert("முதலில் படத்தை பதிவேற்றவும்.");
    const btn = document.getElementById('ocrBtn');
    btn.innerText = "⏳ ஸ்கேன் ஆகிறது...";
    try {
        const { data: { text } } = await Tesseract.recognize(file, 'tam+eng');
        document.getElementById('userPrompt').value = "பதில் அளிக்க வேண்டிய கடிதம்: " + text;
        btn.innerText = "✅ முடிந்தது";
    } catch (e) { btn.innerText = "பிழை"; alert(e); }
}

// AI Draft (placeholder - உண்மையான AI API இணைக்கலாம்)
async function generateAIDraft() {
    const body = document.getElementById('bodyText');
    body.innerHTML = "<i>உருவாக்கப்படுகிறது...</i>";
    setTimeout(() => {
        body.innerText = "இது ஸ்மார்ட் ஸ்கூல் திட்டம் தொடர்பான அதிகாரப்பூர்வ தகவல் தொடர்பு. எங்கள் பள்ளி உள்கட்டமைப்பு நவீனமயமாக்கலின் அடுத்த கட்டத்திற்கு நாங்கள் முன்னேறி வருகிறோம்.";
        document.getElementById('signatory').innerText = "ராஜராஜன்\nதகவல் தொழில்நுட்பத் துறை, AGMHSS";
    }, 1200);
}

// PDF Download with pdfmake (தமிழ் சரியாக வரும்)
function downloadPDF() {
    const date = document.getElementById('currentDate').innerText;
    const salutation = document.getElementById('salutation').innerText;
    const bodyLines = document.getElementById('bodyText').innerText.trim().split('\n').filter(line => line.trim());
    const thanks = document.getElementById('thanksField').innerText;
    const signatory = document.getElementById('signatory').innerText;
    const fontSize = parseInt(document.getElementById('fontSize').value) || 12;

    // Background image base64 (template)
    const bgImage = document.getElementById('bgTemplate').src || null; // data:image/... 

    const docDefinition = {
        pageSize: 'A4',
        pageMargins: [parseInt(document.getElementById('leftMargin').value), parseInt(document.getElementById('topMargin').value), parseInt(document.getElementById('rightMargin').value), 20],

        background: function(currentPage) {
            if (bgImage && currentPage === 1) {
                return {
                    image: bgImage,
                    width: 595, // A4 points (210mm ≈ 595pt at 72dpi)
                    height: 842, // 297mm ≈ 842pt
                    absolutePosition: {x: 0, y: 0}
                };
            }
            return null;
        },

        content: [
            { text: date, alignment: 'right', margin: [0, 0, 0, 10], fontSize: fontSize },
            { text: salutation, bold: true, margin: [0, 0, 0, 20], fontSize: fontSize + 1 },
            bodyLines.map(line => ({ 
                text: line, 
                alignment: 'justify', 
                lineHeight: 1.6, 
                fontSize: fontSize 
            })),
            { text: '', margin: [0, 40] },
            { text: thanks, alignment: 'left', fontSize: fontSize },
            { text: 'உங்கள் உண்மையான,', margin: [0, 5], fontSize: fontSize },
            { text: signatory, bold: true, italics: true, margin: [0, 5], fontSize: fontSize }
        ],

        defaultStyle: {
            font: 'NotoSerifTamil',
            lineHeight: 1.6
        }
    };

    // Noto Serif Tamil font load (URL வழியாக - CORS இல்லாமல் வேலை செய்யும்)
    pdfMake.fonts = {
        NotoSerifTamil: {
            normal: 'https://cdn.jsdelivr.net/gh/google/fonts/ofl/notoseriftamil/NotoSerifTamil-Regular.ttf',
            bold: 'https://cdn.jsdelivr.net/gh/google/fonts/ofl/notoseriftamil/NotoSerifTamil-Bold.ttf',
            italics: 'https://cdn.jsdelivr.net/gh/google/fonts/ofl/notoseriftamil/NotoSerifTamil-Regular.ttf',
            bolditalics: 'https://cdn.jsdelivr.net/gh/google/fonts/ofl/notoseriftamil/NotoSerifTamil-Bold.ttf'
        }
    };

    pdfMake.createPdf(docDefinition).download('AGMHSS_Official_Letter.pdf');
}
</script>
</body>
</html>
