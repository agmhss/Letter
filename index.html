<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Smart Letter Drafter - AGMHSS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/vfs_fonts.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Tamil:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tinos:wght@400;700&display=swap');
        .paper-font { font-family: 'Tinos', serif; }
        
        #letter-preview { 
            width: 210mm; 
            height: 297mm; 
            position: relative; 
            background-color: white;
            margin: 20px auto;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        #bgTemplate {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: stretch;
            z-index: 0;
        }

        #contentArea { 
            position: relative;
            z-index: 10;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        @media print { 
            .no-print { display: none; } 
            body { margin: 0; background: white; }
            #letter-preview { margin: 0; box-shadow: none; }
        }
    </style>
</head>
<body class="bg-slate-300 min-h-screen pb-10 font-sans">

<div class="no-print bg-slate-900 text-white p-4 mb-6 shadow-md flex justify-between items-center px-10">
    <h1 class="text-xl font-bold tracking-tight">AI Letter Pad - AGMHSS</h1>
    <div class="text-xs uppercase tracking-widest text-slate-400 font-semibold">IT Department</div>
</div>

<div class="max-w-[1400px] mx-auto px-4 grid grid-cols-1 lg:grid-cols-12 gap-8">
    
    <div class="lg:col-span-4 space-y-4 no-print">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <h2 class="font-bold text-gray-800 mb-4 border-b pb-2">கட்டுப்பாடுகள் & கருவிகள்</h2>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">1. Letterhead Template</label>
                    <input type="file" id="templateInput" accept="image/*" class="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-slate-100 file:text-slate-700 hover:file:bg-slate-200">
                </div>

                <div class="p-4 bg-indigo-50 rounded-xl border border-indigo-100">
                    <label class="block text-xs font-bold text-indigo-900 uppercase mb-1">2. பெறப்பட்ட கடித ஸ்கேன் (OCR)</label>
                    <input type="file" id="receivedLetterInput" accept="image/*" class="w-full text-xs mb-2">
                    <button onclick="processOCR()" id="ocrBtn" class="w-full bg-indigo-600 text-white py-2 rounded-lg text-sm font-semibold hover:bg-indigo-700">ஸ்கேன் செய்</button>
                </div>

                <div class="space-y-4 bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <p class="text-[10px] font-black text-slate-400 uppercase">எழுத்துரு & மார்ஜின்</p>
                    <div>
                        <div class="flex justify-between text-xs mb-1 font-bold text-indigo-700"><span>அளவு</span><span id="fontVal">12pt</span></div>
                        <input type="range" id="fontSize" min="10" max="24" value="12" class="w-full h-1.5 bg-indigo-200 rounded-lg cursor-pointer accent-indigo-600">
                    </div>
                    <hr class="border-slate-200">
                    <div>
                        <div class="flex justify-between text-xs mb-1 font-medium text-slate-600"><span>மேல்</span><span id="topVal">45mm</span></div>
                        <input type="range" id="topMargin" min="10" max="150" value="45" class="w-full h-1.5 bg-slate-300 rounded-lg cursor-pointer accent-slate-800">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="flex justify-between text-[10px] mb-1 font-bold"><span>இடது</span><span id="leftVal">25mm</span></div>
                            <input type="range" id="leftMargin" min="10" max="80" value="25" class="w-full h-1 bg-slate-300 rounded-lg cursor-pointer accent-slate-800">
                        </div>
                        <div>
                            <div class="flex justify-between text-[10px] mb-1 font-bold"><span>வலது</span><span id="rightVal">20mm</span></div>
                            <input type="range" id="rightMargin" min="10" max="80" value="20" class="w-full h-1 bg-slate-300 rounded-lg cursor-pointer accent-slate-800">
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">3. Groq API Key</label>
                    <input type="text" id="groqApiKey" class="w-full border border-slate-200 rounded-lg p-3 text-sm focus:ring-2 focus:ring-slate-900 outline-none" placeholder="gsk_...">
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">4. கடித நோக்கம் / Context</label>
                    <textarea id="userPrompt" rows="4" class="w-full border border-slate-200 rounded-lg p-3 text-sm focus:ring-2 focus:ring-slate-900 outline-none" placeholder="இந்த கடிதத்திற்கு பதில்..."></textarea>
                </div>

                <button onclick="generateAIDraft()" class="w-full bg-green-700 text-white py-4 rounded-xl font-bold hover:bg-green-800 shadow-lg">AI பதில் உருவாக்கு (Groq)</button>
            </div>
        </div>
    </div>

    <div class="lg:col-span-8 flex flex-col items-center">
        <div class="sticky top-6 w-full max-w-[210mm]">
            <div id="letter-preview" class="paper-font text-slate-900 bg-white">
                <img id="bgTemplate" class="hidden" alt="Letterhead">
                
                <div id="contentArea" style="padding: 45mm 20mm 20mm 25mm; font-size: 12pt; line-height: 1.6;">
                    <div class="text-right">
                        <span contenteditable="true" id="currentDate" class="outline-none border-b border-transparent hover:border-slate-300"></span>
                    </div>
                    
                    <div id="salutation" contenteditable="true" class="font-bold mt-6">மதிப்பிற்குரிய ஐயா/அம்மா,</div>
                    
                    <div id="bodyText" contenteditable="true" class="text-justify min-h-[400px] hover:bg-slate-50 mt-6">
                        டெம்ப்ளேட் பதிவேற்றி, Groq key உள்ளிட்டு AI உதவியுடன் பதில் உருவாக்கலாம்.
                    </div>
                    
                    <div id="closing" class="mt-auto pb-20">
                        <div id="thanksField" contenteditable="true" class="hover:bg-slate-50">நன்றி,</div>
                        <div class="pt-8">
                            <p>உங்கள் உண்மையான,</p>
                            <p id="signatory" contenteditable="true" class="font-bold mt-4 italic">[பெயர்/பதவி]</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <button onclick="downloadPDF()" class="no-print mt-6 w-full bg-rose-600 text-white py-4 rounded-xl font-bold shadow-xl hover:bg-rose-700">
                PDF பதிவிறக்கம்
            </button>
        </div>
    </div>
</div>

<script>
// தேதி தமிழில்
document.getElementById('currentDate').innerText = new Date().toLocaleDateString('ta-IN', {day:'numeric', month:'long', year:'numeric'});

// Sliders
const contentArea = document.getElementById('contentArea');
document.getElementById('fontSize').oninput = e => {
    contentArea.style.fontSize = e.target.value + 'pt';
    document.getElementById('fontVal').innerText = e.target.value + 'pt';
};
['topMargin','leftMargin','rightMargin'].forEach(id => {
    document.getElementById(id).oninput = e => {
        const prop = id==='topMargin'?'paddingTop':(id==='leftMargin'?'paddingLeft':'paddingRight');
        const val = e.target.value + 'mm';
        contentArea.style[prop] = val;
        document.getElementById(id.replace('Margin','Val')).innerText = val;
    };
});

// Template upload
document.getElementById('templateInput').onchange = e => {
    const reader = new FileReader();
    reader.onload = ev => {
        const img = document.getElementById('bgTemplate');
        img.src = ev.target.result;
        img.classList.remove('hidden');
    };
    reader.readAsDataURL(e.target.files[0]);
};

// OCR (Tamil + English)
async function processOCR() {
    const file = document.getElementById('receivedLetterInput').files[0];
    if (!file) return alert("படம் தேர்ந்தெடுக்கவும்");
    const btn = document.getElementById('ocrBtn');
    btn.innerText = "ஸ்கேன் ஆகிறது..."; btn.disabled = true;
    try {
        const { data: { text } } = await Tesseract.recognize(file, 'tam+eng');
        document.getElementById('userPrompt').value = "இந்த அதிகாரப்பூர்வ கடிதத்திற்கு மரியாதையான தமிழில் பதில் எழுதவும்:\n\n" + text.trim();
        btn.innerText = "முடிந்தது";
    } catch (e) {
        btn.innerText = "பிழை";
        alert("OCR பிழை: " + e.message);
    } finally { btn.disabled = false; }
}

// Groq AI Draft
async function generateAIDraft() {
    const key = document.getElementById('groqApiKey').value.trim();
    if (!key) return alert("Groq API Key உள்ளிடவும்");
    const prompt = document.getElementById('userPrompt').value.trim();
    if (!prompt) return alert("Context உள்ளிடவும்");

    const body = document.getElementById('bodyText');
    body.innerHTML = "<i>உருவாக்கப்படுகிறது...</i>";

    try {
        const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": `Bearer ${key}` },
            body: JSON.stringify({
                model: "llama3-8b-8192",  // stable & fast
                // or
                model: "llama-3.1-8b-instant",  // Best direct replacement – fast & cheap
// or
// model: "llama-3.3-70b-versatile",  // Better quality for formal Tamil letters
                messages: [
                    { role: "system", content: "நீங்கள் அதிகாரப்பூர்வ தமிழ் கடித எழுத்தாளர். மரியாதையாக, சுருக்கமாக, தெளிவாக எழுதவும். முழு கடிதம் மட்டும் தரவும்." },
                    { role: "user", content: prompt }
                ],
                temperature: 0.7,
                max_tokens: 12000
            })
        });
        if (!res.ok) {
            const err = await res.json();
            throw new Error(JSON.stringify(err.error || err));
        }
        const data = await res.json();
        body.innerText = data.choices[0].message.content.trim();
    } catch (e) {
        console.error(e);
        body.innerHTML = `<span class="text-red-600">பிழை: ${e.message}</span>`;
        alert("Groq பிழை - console பார்க்கவும் (F12)");
    }
}

// PDF Download with Tamil font support
function downloadPDF() {
    const date = document.getElementById('currentDate').innerText;
    const salutation = document.getElementById('salutation').innerText;
    const bodyLines = document.getElementById('bodyText').innerText.trim().split('\n').filter(l => l.trim());
    const thanks = document.getElementById('thanksField').innerText;
    const signatory = document.getElementById('signatory').innerText;
    const fontSize = parseInt(document.getElementById('fontSize').value) || 12;
    const bg = document.getElementById('bgTemplate').src || null;

    // Paste your base64 here ↓↓↓ (very long string)
    const notoBase64 = 'YOUR_BASE64_STRING_HERE_FROM_NOTO_SERIF_TAMIL_REGULAR_TTF';

    pdfMake.vfs = {
        'NotoSerifTamil-Regular.ttf': notoBase64
    };

    pdfMake.fonts = {
        NotoSerifTamil: {
            normal: 'NotoSerifTamil-Regular.ttf',
            bold: 'NotoSerifTamil-Regular.ttf',
            italics: 'NotoSerifTamil-Regular.ttf',
            bolditalics: 'NotoSerifTamil-Regular.ttf'
        }
    };

    const dd = {
        pageSize: 'A4',
        pageMargins: [parseInt(document.getElementById('leftMargin').value || 25),
                      parseInt(document.getElementById('topMargin').value || 45),
                      parseInt(document.getElementById('rightMargin').value || 20), 30],
        background: bg ? [{image: bg, width: 595, height: 842, absolutePosition: {x:0, y:0}}] : null,
        content: [
            {text: date, alignment: 'right', margin: [0,0,0,10], fontSize},
            {text: salutation, bold: true, margin: [0,10,0,20], fontSize: fontSize+1},
            bodyLines.map(l => ({text: l, alignment: 'justify', lineHeight: 1.6, fontSize, font: 'NotoSerifTamil'})),
            {text: '', margin: [0,40]},
            {text: thanks, alignment: 'left', fontSize, margin: [0,0,0,5], font: 'NotoSerifTamil'},
            {text: 'உங்கள் உண்மையான,', fontSize, margin: [0,5], font: 'NotoSerifTamil'},
            {text: signatory, bold: true, italics: true, fontSize, margin: [0,10], font: 'NotoSerifTamil'}
        ],
        defaultStyle: {font: 'NotoSerifTamil', lineHeight: 1.6}
    };

    pdfMake.createPdf(dd).download('AGMHSS_பதில்_கடிதம்.pdf');
}
</script>
</body>
    </html>
