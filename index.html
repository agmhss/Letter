<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Smart Letter Drafter - AGMHSS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/vfs_fonts.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Tamil:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tinos:wght@400;700&display=swap');
        .paper-font { font-family: 'Tinos', 'Noto Serif Tamil', serif; }
        
        #letter-preview { 
            width: 210mm; 
            height: 297mm; 
            position: relative; 
            background-color: white;
            margin: 20px auto;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        #bgTemplate {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: stretch;
            z-index: 0;
        }

        #contentArea { 
            position: relative;
            z-index: 10;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 45mm 20mm 20mm 25mm;
        }

        .ai-limited { max-height: 650px; overflow: hidden; }

        @media print { 
            .no-print { display: none; } 
            body { margin: 0; background: white; }
            #letter-preview { margin: 0; box-shadow: none; }
        }
    </style>
</head>
<body class="bg-slate-300 min-h-screen pb-10 font-sans">

<div class="no-print bg-slate-900 text-white p-4 mb-6 shadow-md flex justify-between items-center px-10">
    <h1 class="text-xl font-bold tracking-tight">AI Letter Pad - AGMHSS</h1>
    <div class="text-xs uppercase tracking-widest text-slate-400 font-semibold">IT Department</div>
</div>

<div class="max-w-[1400px] mx-auto px-4 grid grid-cols-1 lg:grid-cols-12 gap-8">
    
    <div class="lg:col-span-4 space-y-4 no-print">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <h2 class="font-bold text-gray-800 mb-4 border-b pb-2">роХроЯрпНроЯрпБрокрпНрокро╛роЯрпБроХро│рпН & Tools</h2>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">1. Letterhead Template</label>
                    <input type="file" id="templateInput" accept="image/*" class="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-slate-100 file:text-slate-700 hover:file:bg-slate-200">
                </div>

                <div class="p-4 bg-indigo-50 rounded-xl border border-indigo-100">
                    <label class="block text-xs font-bold text-indigo-900 uppercase mb-1">2. Received Letter Scan (OCR)</label>
                    <input type="file" id="receivedLetterInput" accept="image/*" class="w-full text-xs mb-2">
                    <button onclick="processOCR()" id="ocrBtn" class="w-full bg-indigo-600 text-white py-2 rounded-lg text-sm font-semibold hover:bg-indigo-700">Scan & Extract</button>
                </div>

                <div class="space-y-4 bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <p class="text-[10px] font-black text-slate-400 uppercase">Font & Margins</p>
                    <div>
                        <div class="flex justify-between text-xs mb-1 font-bold text-indigo-700">
                            <span>роЕро│ро╡рпБ / Size</span><span id="fontVal">12pt</span>
                        </div>
                        <input type="range" id="fontSize" min="10" max="16" value="12" class="w-full h-1.5 bg-indigo-200 rounded-lg cursor-pointer accent-indigo-600">
                    </div>
                    <hr class="border-slate-200">
                    <div>
                        <div class="flex justify-between text-xs mb-1 font-medium text-slate-600">
                            <span>роорпЗро▓рпН / Top</span><span id="topVal">45mm</span>
                        </div>
                        <input type="range" id="topMargin" min="30" max="80" value="45" class="w-full h-1.5 bg-slate-300 rounded-lg cursor-pointer accent-slate-800">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="flex justify-between text-[10px] mb-1 font-bold">
                                <span>роЗроЯродрпБ / Left</span><span id="leftVal">25mm</span>
                            </div>
                            <input type="range" id="leftMargin" min="15" max="40" value="25" class="w-full h-1 bg-slate-300 rounded-lg cursor-pointer accent-slate-800">
                        </div>
                        <div>
                            <div class="flex justify-between text-[10px] mb-1 font-bold">
                                <span>ро╡ро▓родрпБ / Right</span><span id="rightVal">20mm</span>
                            </div>
                            <input type="range" id="rightMargin" min="15" max="40" value="20" class="w-full h-1 bg-slate-300 rounded-lg cursor-pointer accent-slate-800">
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">3. Groq API Key</label>
                    <input type="password" id="groqApiKey" class="w-full border border-slate-200 rounded-lg p-3 text-sm focus:ring-2 focus:ring-slate-900 outline-none" placeholder="gsk_...">
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">4. Letter Context / роХроЯро┐род роирпЛроХрпНроХроорпН</label>
                    <textarea id="userPrompt" rows="3" class="w-full border border-slate-200 rounded-lg p-3 text-sm focus:ring-2 focus:ring-slate-900 outline-none" placeholder="роЗроирпНрод роХроЯро┐родродрпНродро┐ро▒рпНроХрпБ рокродро┐ро▓рпН роОро┤рпБрод... / Reply context in English/Tamil"></textarea>
                </div>

                <button onclick="generateAIDraft()" class="w-full bg-green-700 text-white py-4 rounded-xl font-bold hover:bg-green-800 shadow-lg">Generate AI Reply</button>
            </div>
        </div>
    </div>

    <div class="lg:col-span-8 flex flex-col items-center">
        <div class="sticky top-6 w-full max-w-[210mm]">
            <div id="letter-preview" class="paper-font text-slate-900 bg-white">
                <img id="bgTemplate" class="hidden" alt="Letterhead">
                
                <div id="contentArea">
                    <div id="salutation" contenteditable="true" class="font-bold mt-6">роородро┐рокрпНрокро┐ро▒рпНроХрпБро░ро┐роп роРропро╛/роЕроорпНрооро╛ / Dear Sir/Madam,</div>
                    
                    <div id="bodyText" contenteditable="true" class="text-justify min-h-[400px] hover:bg-slate-50 mt-6 ai-limited">
                        роЯрпЖроорпНрокрпНро│рпЗроЯрпН рокродро┐ро╡рпЗро▒рпНро▒ро┐, Groq key роЙро│рпНро│ро┐роЯрпНроЯрпБ AI роЙродро╡ро┐ропрпБроЯройрпН рокродро┐ро▓рпН роЙро░рпБро╡ро╛роХрпНроХро▓ро╛роорпН.
                    </div>
                    
                    <div class="mt-auto pb-20 flex-grow-0">
                        <div id="thanksField" contenteditable="true" class="hover:bg-slate-50">роиройрпНро▒ро┐ / Thanks,</div>
                        <div class="pt-8">
                            <p>роЙроЩрпНроХро│рпН роЙрогрпНроорпИропро╛рой / Yours sincerely,</p>
                            <p id="signatory" contenteditable="true" class="font-bold mt-4 italic">[рокрпЖропро░рпН/Designation]</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <button onclick="downloadPDF()" class="no-print mt-6 w-full bg-rose-600 text-white py-4 rounded-xl font-bold shadow-xl hover:bg-rose-700">
                ЁЯУД PDF Download
            </button>
        </div>
    </div>
</div>

<script>
let currentFontSize = 12;

// Sliders with bilingual labels
document.getElementById('fontSize').oninput = e => {
    currentFontSize = e.target.value;
    document.getElementById('contentArea').style.fontSize = e.target.value + 'pt';
    document.getElementById('fontVal').innerText = e.target.value + 'pt';
};

['topMargin','leftMargin','rightMargin'].forEach(id => {
    document.getElementById(id).oninput = e => {
        const prop = id==='topMargin'?'paddingTop':(id==='leftMargin'?'paddingLeft':'paddingRight');
        const val = e.target.value + 'mm';
        document.getElementById('contentArea').style[prop] = val;
        document.getElementById(id.replace('Margin','Val')).innerText = val;
    };
});

// Template upload
document.getElementById('templateInput').onchange = e => {
    const reader = new FileReader();
    reader.onload = ev => {
        const img = document.getElementById('bgTemplate');
        img.src = ev.target.result;
        img.classList.remove('hidden');
    };
    reader.readAsDataURL(e.target.files[0]);
};

// Improved OCR
async function processOCR() {
    const file = document.getElementById('receivedLetterInput').files[0];
    if (!file) return alert("рокроЯроорпН родрпЗро░рпНроирпНродрпЖроЯрпБроХрпНроХро╡рпБроорпН / Please select image");
    
    const btn = document.getElementById('ocrBtn');
    btn.innerText = "Scanning..."; btn.disabled = true;
    
    try {
        const { data: { text } } = await Tesseract.recognize(file, 'tam+eng', {
            logger: m => console.log(m)
        });
        document.getElementById('userPrompt').value = `роЗроирпНрод роХроЯро┐родродрпНродро┐ро▒рпНроХрпБ рооро░ро┐ропро╛родрпИропро╛рой родрооро┐ро┤рпН/роЗроЩрпНроХро┐ро▓рпАро╖рпН рокродро┐ро▓рпН: \n\n${text.trim().substring(0, 500)}`;
        btn.innerText = "тЬЕ Extracted";
        setTimeout(() => btn.innerText = "Scan & Extract", 2000);
    } catch (e) {
        alert("OCR Error: " + e.message);
        btn.innerText = "тЭМ Error";
    } finally { 
        setTimeout(() => btn.disabled = false, 1000); 
    }
}

// Improved AI Draft - ONE PAGE LIMIT
async function generateAIDraft() {
    const key = document.getElementById('groqApiKey').value.trim();
    if (!key) return alert("Groq API Key родрпЗро╡рпИ / Required");
    
    const prompt = document.getElementById('userPrompt').value.trim();
    if (!prompt) return alert("Context родрпЗро╡рпИ / Required");

    const body = document.getElementById('bodyText');
    body.innerHTML = "ЁЯдЦ AI роЙро░рпБро╡ро╛роХрпНроХрпБроХро┐ро▒родрпБ...";

    try {
        const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: { 
                "Content-Type": "application/json", 
                "Authorization": `Bearer ${key}` 
            },
            body: JSON.stringify({
                model: "llama-3.1-8b-instant",  // Best direct replacement тАУ fast & cheap
// or
// model: "llama-3.3-70b-versatile",  // Better quality for formal Tamil letters
                messages: [
                    {
                        role: "system", 
                        content: `роирпАроЩрпНроХро│рпН роЕродро┐роХро╛ро░рокрпНрокрпВро░рпНро╡ роХроЯро┐род роОро┤рпБродрпНродро╛ро│ро░рпН. 
                        тЬЕ роТро░рпБ A4 рокроХрпНроХродрпНродро┐ро▒рпНроХрпБро│рпН роороЯрпНроЯрпБроорпН (600 роЪрпКро▒рпНроХро│рпН max)
                        тЬЕ родрооро┐ро┤рпН/роЗроЩрпНроХро┐ро▓рпАро╖рпН mix OK
                        тЬЕ рооро░ро┐ропро╛родрпИ, роЪрпБро░рпБроХрпНроХроорпН, родрпЖро│ро┐ро╡рпБ
                        тЬЕ роорпБро┤рпБ body text роороЯрпНроЯрпБроорпН родро░ро╡рпБроорпН (no intro/outro)`
                    },
                    { role: "user", content: `${prompt}\n\n[роТро░рпБ рокроХрпНроХроорпН роороЯрпНроЯрпБроорпН - 500-600 роЪрпКро▒рпНроХро│рпН]` }
                ],
                temperature: 0.3,
                max_tokens: 800  // Strictly limited for 1 page
            })
        });

        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error?.message || 'API Error');
        }
        
        const data = await res.json();
        const aiText = data.choices[0].message.content.trim();
        
        // Enforce 1-page limit
        const limitedText = aiText.length > 2500 ? aiText.substring(0, 2500) + '\n\n... (1 page limit)' : aiText;
        body.innerText = limitedText;
        
    } catch (e) {
        console.error(e);
        body.innerHTML = `тЭМ Error: ${e.message}`;
    }
}

// Enhanced PDF Download - Better Tamil rendering
function downloadPDF() {
    const salutation = document.getElementById('salutation').innerText.trim();
    const bodyText = document.getElementById('bodyText').innerText.trim();
    const thanks = document.getElementById('thanksField').innerText.trim();
    const signatory = document.getElementById('signatory').innerText.trim();
    const bg = document.getElementById('bgTemplate').src;

    // Use Google Fonts Noto Tamil (no base64 needed)
    pdfMake.fonts = {
        Tamil: {
            normal: 'https://fonts.gstatic.com/s/notoseriftamil/v23/xn7gGh-Hg80RekT-Zq0hD9jGm3o9f9Cj.woff2',
            bold: 'https://fonts.gstatic.com/s/notoseriftamil/v23/xn7gGh-Hg80RekT-Zq0hD9jGm3o9f9Cj.woff2',
            italics: 'https://fonts.gstatic.com/s/notoseriftamil/v23/xn7gGh-Hg80RekT-Zq0hD9jGm3o9f9Cj.woff2'
        }
    };

    const bodyLines = bodyText.split('\n').filter(line => line.trim()).slice(0, 45); // Max 45 lines = 1 page

    const docDefinition = {
        pageSize: 'A4',
        pageMargins: [25, 45, 20, 30],
        pageOrientation: 'portrait',
        background: bg ? [{
            image: bg, 
            width: 595.28, 
            height: 841.89, 
            absolutePosition: {x: 0, y: 0}
        }] : null,
        content: [
            // Salutation
            {
                text: salutation, 
                bold: true, 
                fontSize: currentFontSize + 1,
                margin: [0, 20, 0, 15],
                font: 'Tamil'
            },
            // Body - Strictly 1 page
            {
                stack: bodyLines.map(line => ({
                    text: line.trim(),
                    fontSize: currentFontSize,
                    lineHeight: 1.4,
                    margin: [0, 2, 0, 2],
                    font: 'Tamil'
                })),
                margin: [0, 0, 0, 30]
            },
            // Closing
            {
                text: thanks, 
                fontSize: currentFontSize,
                margin: [0, 0, 0, 8],
                font: 'Tamil'
            },
            {
                text: 'роЙроЩрпНроХро│рпН роЙрогрпНроорпИропро╛рой / Yours sincerely,', 
                fontSize: currentFontSize - 0.5,
                margin: [0, 4, 0, 8],
                font: 'Tamil'
            },
            {
                text: signatory, 
                bold: true, 
                italics: true,
                fontSize: currentFontSize,
                font: 'Tamil'
            }
        ],
        defaultStyle: {
            font: 'Tamil',
            fontSize: currentFontSize,
            lineHeight: 1.4
        }
    };

    pdfMake.createPdf(docDefinition).download('AGMHSS_Letter_' + Date.now() + '.pdf');
}
</script>
</body>
</html>
