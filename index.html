<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Smart Letter Drafter - AGMHSS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js"></script>
    
    <!-- pdfmake -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/vfs_fonts.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tinos:wght@400;700&display=swap');
        .paper-font { font-family: 'Tinos', serif; }
        
        #letter-preview { 
            width: 210mm; 
            height: 297mm; 
            position: relative; 
            background-color: white;
            margin: 20px auto;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        #bgTemplate {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: stretch;
            z-index: 0;
        }

        #contentArea { 
            position: relative;
            z-index: 10;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        @media print { 
            .no-print { display: none; } 
            body { margin: 0; background: white; }
            #letter-preview { margin: 0; box-shadow: none; }
        }
    </style>
</head>
<body class="bg-slate-300 min-h-screen pb-10">

<div class="no-print bg-slate-900 text-white p-4 mb-6 shadow-md flex justify-between items-center px-10">
    <h1 class="text-xl font-bold tracking-tight">AI Letter Pad SPA - AGMHSS</h1>
    <div class="text-xs uppercase tracking-widest text-slate-400 font-semibold">IT Department</div>
</div>

<div class="max-w-[1400px] mx-auto px-4 grid grid-cols-1 lg:grid-cols-12 gap-8">
    
    <div class="lg:col-span-4 space-y-4 no-print">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <h2 class="font-bold text-gray-800 mb-4 border-b pb-2">கட்டுப்பாடுகள் & கருவிகள்</h2>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">1. Letterhead Template (பின்னணி படம்)</label>
                    <input type="file" id="templateInput" accept="image/*" class="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-slate-100 file:text-slate-700 hover:file:bg-slate-200">
                </div>

                <div class="p-4 bg-indigo-50 rounded-xl border border-indigo-100">
                    <label class="block text-xs font-bold text-indigo-900 uppercase mb-1">2. பெறப்பட்ட கடிதத்தை ஸ்கேன் செய் (OCR)</label>
                    <input type="file" id="receivedLetterInput" accept="image/*" class="w-full text-xs mb-2">
                    <button onclick="processOCR()" id="ocrBtn" class="w-full bg-indigo-600 text-white py-2 rounded-lg text-sm font-semibold hover:bg-indigo-700">ஸ்கேன் செய்</button>
                </div>

                <div class="space-y-4 bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <p class="text-[10px] font-black text-slate-400 uppercase">எழுத்துரு & இடைவெளி</p>
                    
                    <div>
                        <div class="flex justify-between text-xs mb-1 font-bold text-indigo-700"><span>எழுத்துரு அளவு</span><span id="fontVal">12pt</span></div>
                        <input type="range" id="fontSize" min="10" max="24" value="12" class="w-full h-1.5 bg-indigo-200 rounded-lg appearance-none cursor-pointer accent-indigo-600">
                    </div>

                    <hr class="border-slate-200">

                    <div>
                        <div class="flex justify-between text-xs mb-1 font-medium text-slate-600"><span>மேல் இடைவெளி</span><span id="topVal">45mm</span></div>
                        <input type="range" id="topMargin" min="10" max="150" value="45" class="w-full h-1.5 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-slate-800">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="flex justify-between text-[10px] mb-1 font-bold"><span>இடது</span><span id="leftVal">25mm</span></div>
                            <input type="range" id="leftMargin" min="10" max="80" value="25" class="w-full h-1 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-slate-800">
                        </div>
                        <div>
                            <div class="flex justify-between text-[10px] mb-1 font-bold"><span>வலது</span><span id="rightVal">20mm</span></div>
                            <input type="range" id="rightMargin" min="10" max="80" value="20" class="w-full h-1 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-slate-800">
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">3. Groq API Key (தேவைப்படும்)</label>
                    <input type="text" id="groqApiKey" class="w-full border border-slate-200 rounded-lg p-3 text-sm focus:ring-2 focus:ring-slate-900 outline-none" placeholder="gsk_xxxxxxxxxxxxxxxxxxxx">
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">4. கடித நோக்கம் / Context (அல்லது ஸ்கேன் செய்தது தானாக வரும்)</label>
                    <textarea id="userPrompt" rows="4" class="w-full border border-slate-200 rounded-lg p-3 text-sm focus:ring-2 focus:ring-slate-900 outline-none" placeholder="இந்த கடிதத்திற்கு பதில் அளிக்க வேண்டும்..."></textarea>
                </div>

                <button onclick="generateAIDraft()" class="w-full bg-green-700 text-white py-4 rounded-xl font-bold hover:bg-green-800 transition-all shadow-lg">AI மூலம் பதில் வரைவு உருவாக்கு (Groq)</button>
            </div>
        </div>
    </div>

    <div class="lg:col-span-8 flex flex-col items-center">
        <div class="sticky top-6 w-full">
            <div id="letter-preview" class="paper-font text-slate-900">
                <img id="bgTemplate" class="hidden" alt="Template">
                
                <div id="contentArea" style="padding: 45mm 20mm 20mm 25mm; font-size: 12pt;">
                    <div class="text-right">
                        <span contenteditable="true" id="currentDate" class="outline-none border-b border-transparent hover:border-slate-300"></span>
                    </div>
                    
                    <div id="salutation" contenteditable="true" class="font-bold outline-none hover:bg-slate-50 mt-6">மதிப்பிற்குரிய ஐயா/அம்மா,</div>
                    
                    <div id="bodyText" contenteditable="true" class="leading-relaxed text-justify outline-none min-h-[400px] hover:bg-slate-50 mt-6">
                        டெம்ப்ளேட் பதிவேற்றி, இடது பக்கத்தில் உள்ள கட்டுப்பாடுகளை பயன்படுத்தவும். Groq API key உள்ளிட்டு AI பதில் உருவாக்கலாம்.
                    </div>
                    
                    <div id="closing" class="mt-auto pb-20">
                        <div id="thanksField" contenteditable="true" class="outline-none hover:bg-slate-50">நன்றி,</div>
                        <div class="pt-8">
                            <p>உங்கள் உண்மையான,</p>
                            <p id="signatory" contenteditable="true" class="font-bold mt-4 outline-none hover:bg-slate-50 italic">[பெயர் / பதவி]</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <button onclick="downloadPDF()" class="no-print mt-6 w-full bg-rose-600 text-white py-4 rounded-xl font-bold shadow-xl hover:bg-rose-700 flex items-center justify-center gap-3 active:scale-95 transition-all">
                PDF பதிவிறக்கம்
            </button>
        </div>
    </div>
</div>

<script>
// தேதி (தமிழில்)
document.getElementById('currentDate').innerText = new Date().toLocaleDateString('ta-IN', { day: 'numeric', month: 'long', year: 'numeric' });

// Sliders logic (மாற்றமில்லை)
const content = document.getElementById('contentArea');
document.getElementById('fontSize').oninput = function() {
    content.style.fontSize = this.value + "pt";
    document.getElementById('fontVal').innerText = this.value + "pt";
};

['topMargin', 'leftMargin', 'rightMargin'].forEach(id => {
    const el = document.getElementById(id);
    el.oninput = function() {
        const prop = id === 'topMargin' ? 'paddingTop' : (id === 'leftMargin' ? 'paddingLeft' : 'paddingRight');
        const val = this.value + "mm";
        content.style[prop] = val;
        document.getElementById(id.replace('Margin','Val')).innerText = val;
    };
});

// Template upload
document.getElementById('templateInput').onchange = e => {
    const reader = new FileReader();
    reader.onload = ev => {
        const img = document.getElementById('bgTemplate');
        img.src = ev.target.result;
        img.classList.remove('hidden');
    };
    reader.readAsDataURL(e.target.files[0]);
};

// OCR - தமிழ் + ஆங்கிலம்
async function processOCR() {
    const file = document.getElementById('receivedLetterInput').files[0];
    if (!file) return alert("படத்தை முதலில் தேர்ந்தெடுக்கவும்.");
    const btn = document.getElementById('ocrBtn');
    btn.innerText = "⏳ ஸ்கேன் ஆகிறது..."; btn.disabled = true;
    try {
        const { data: { text } } = await Tesseract.recognize(file, 'tam+eng', { logger: m => console.log(m) });
        document.getElementById('userPrompt').value = "பின்வரும் கடிதத்திற்கு அதிகாரப்பூர்வ தமிழில் பதில் எழுதவும்:\n\n" + text.trim();
        btn.innerText = "✅ முடிந்தது"; btn.disabled = false;
    } catch (e) {
        console.error(e);
        btn.innerText = "பிழை"; btn.disabled = false;
        alert("OCR பிழை: " + e.message);
    }
}

// Groq API மூலம் AI Draft
async function generateAIDraft() {
    const apiKey = document.getElementById('groqApiKey').value.trim();
    if (!apiKey) return alert("Groq API Key உள்ளிடவும்!");

    const promptText = document.getElementById('userPrompt').value.trim();
    if (!promptText) return alert("கடித நோக்கம் அல்லது context உள்ளிடவும்!");

    const body = document.getElementById('bodyText');
    body.innerHTML = "<i>AI உருவாக்குகிறது... (Groq cloud)</i>";

    try {
        const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model: "llama-3.1-70b-versatile",  // அல்லது mixtral-8x7b-32768, gemma2-9b-it போன்றவை
                messages: [
                    { role: "system", content: "நீங்கள் ஒரு அதிகாரப்பூர்வ தமிழ் கடித எழுத்தாளர். பள்ளி/அலுவலக கடிதங்கள் மிகவும் மரியாதையாக, சுருக்கமாக, தெளிவாக எழுத வேண்டும். முழு பதில் கடிதத்தை மட்டும் திருப்பி அனுப்பவும் - வேறு எந்த விளக்கமும் வேண்டாம்." },
                    { role: "user", content: promptText }
                ],
                temperature: 0.7,
                max_tokens: 1500
            })
        });

        if (!response.ok) throw new Error(`Groq API பிழை: ${response.status}`);

        const data = await response.json();
        const generatedText = data.choices[0].message.content.trim();

        body.innerText = generatedText;
    } catch (err) {
        console.error(err);
        body.innerHTML = `<span class="text-red-600">பிழை: ${err.message}</span>`;
        alert("Groq API பிழை: API key சரியா? அல்லது network பிரச்சினையா? Console-ஐ பார்க்கவும்.");
    }
}

// PDF Download (font issue fix - Roboto default, தமிழுக்கு Noto local embed பரிந்துரை)
function downloadPDF() {
    const date = document.getElementById('currentDate').innerText;
    const salutation = document.getElementById('salutation').innerText;
    const bodyLines = document.getElementById('bodyText').innerText.trim().split('\n').filter(l => l.trim());
    const thanks = document.getElementById('thanksField').innerText;
    const signatory = document.getElementById('signatory').innerText;
    const fontSize = parseInt(document.getElementById('fontSize').value) || 12;

    const bgImage = document.getElementById('bgTemplate').src || null;

    const docDefinition = {
        pageSize: 'A4',
        pageMargins: [
            parseInt(document.getElementById('leftMargin').value),
            parseInt(document.getElementById('topMargin').value),
            parseInt(document.getElementById('rightMargin').value),
            30
        ],

        background: bgImage ? function() {
            return { image: bgImage, width: 595, height: 842, absolutePosition: {x: 0, y: 0} };
        } : null,

        content: [
            { text: date, alignment: 'right', margin: [0, 0, 0, 10], fontSize },
            { text: salutation, bold: true, margin: [0, 10, 0, 20], fontSize: fontSize + 1 },
            bodyLines.map(line => ({ text: line, alignment: 'justify', lineHeight: 1.6, fontSize })),
            { text: '', margin: [0, 40] },
            { text: thanks, alignment: 'left', fontSize, margin: [0, 0, 0, 5] },
            { text: 'உங்கள் உண்மையான,', fontSize, margin: [0, 5] },
            { text: signatory, bold: true, italics: true, fontSize, margin: [0, 10] }
        ],

        defaultStyle: {
            font: 'Roboto',  // Default - பிழை வராமல் இருக்க
            lineHeight: 1.6
        }
    };

    pdfMake.createPdf(docDefinition).download('AGMHSS_Padhil_Kaditham.pdf');
}
</script>
</body>
    </html>
