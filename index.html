<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Smart Letter Drafter - AGMHSS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Tamil:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        .paper-font { font-family: 'Tinos', 'Noto Serif Tamil', serif; }
       
        #letter-preview {
            width: 210mm;
            min-height: 297mm; /* min-height allows content to grow */
            position: relative;
            background-color: white;
            margin: 20px auto;
            overflow: visible; /* critical: don't clip content */
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            page-break-inside: avoid;
            page-break-after: avoid;
        }
       
        #bgTemplate {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: fill;
            z-index: 0;
        }
        #contentArea {
            position: relative;
            z-index: 10;
            min-height: 297mm;
            display: flex;
            flex-direction: column;
            padding: 45mm 20mm 20mm 25mm;
        }
        #bodyText { outline: none; white-space: pre-wrap; }
        @media print {
            .no-print { display: none; }
            body { background: white; padding: 0; margin: 0; }
            #letter-preview { margin: 0; box-shadow: none; overflow: visible !important; }
        }
    </style>
</head>
<body class="bg-slate-300 min-h-screen pb-10 font-sans">
<div class="no-print bg-slate-900 text-white p-4 mb-6 shadow-md flex justify-between items-center px-10">
    <h1 class="text-xl font-bold tracking-tight">AI Letter Pad - AGMHSS</h1>
    <div class="text-xs uppercase tracking-widest text-slate-400 font-semibold">IT Department</div>
</div>
<div class="max-w-[1400px] mx-auto px-4 grid grid-cols-1 lg:grid-cols-12 gap-8">
   
    <div class="lg:col-span-4 space-y-4 no-print">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <h2 class="font-bold text-gray-800 mb-4 border-b pb-2">Tools</h2>
           
            <div class="space-y-6">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">1. Letterhead Template</label>
                    <input type="file" id="templateInput" accept="image/*" class="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-slate-100 file:text-slate-700 hover:file:bg-slate-200">
                </div>
                <div class="p-4 bg-indigo-50 rounded-xl border border-indigo-100">
                    <label class="block text-xs font-bold text-indigo-900 uppercase mb-1">2. Received Letter Scan (OCR)</label>
                    <input type="file" id="receivedLetterInput" accept="image/*" class="w-full text-xs mb-2">
                    <button onclick="processOCR()" id="ocrBtn" class="w-full bg-indigo-600 text-white py-2 rounded-lg text-sm font-semibold hover:bg-indigo-700">Scan & Extract</button>
                </div>
                <div class="space-y-4 bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <p class="text-[10px] font-black text-slate-400 uppercase">Font & Margins</p>
                    <div>
                        <div class="flex justify-between text-xs mb-1 font-bold text-indigo-700">
                            <span>Size</span><span id="fontVal">12pt</span>
                        </div>
                        <input type="range" id="fontSize" min="10" max="20" value="12" class="w-full h-1.5 bg-indigo-200 rounded-lg cursor-pointer accent-indigo-600">
                    </div>
                    <div>
                        <div class="flex justify-between text-xs mb-1 font-medium text-slate-600">
                            <span>Top Margin</span><span id="topVal">45mm</span>
                        </div>
                        <div>
                        <div class="flex justify-between text-xs mb-1 font-medium text-slate-600"><span>‡ÆÆ‡Øá‡Æ≤‡Øç ‡Æá‡Æü‡Øà‡Æµ‡ØÜ‡Æ≥‡Æø</span><span id="topVal">45mm</span></div>
                        <input type="range" id="topMargin" min="10" max="180" value="45" class="w-full h-1.5 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-slate-800">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="flex justify-between text-[10px] mb-1 font-bold"><span>‡Æá‡Æü‡Æ§‡ØÅ</span><span id="leftVal">25mm</span></div>
                            <input type="range" id="leftMargin" min="10" max="80" value="25" class="w-full h-1 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-slate-800">
                        </div>
                        <div>
                            <div class="flex justify-between text-[10px] mb-1 font-bold"><span>‡Æµ‡Æ≤‡Æ§‡ØÅ</span><span id="rightVal">20mm</span></div>
                            <input type="range" id="rightMargin" min="10" max="80" value="20" class="w-full h-1 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-slate-800">
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">3. Groq API Key</label>
                    <input type="password" id="groqApiKey" class="w-full border border-slate-200 rounded-lg p-3 text-sm focus:ring-2 focus:ring-slate-900 outline-none" placeholder="gsk_...">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">4. Letter Context</label>
                    <textarea id="userPrompt" rows="3" class="w-full border border-slate-200 rounded-lg p-3 text-sm focus:ring-2 focus:ring-slate-900 outline-none" placeholder="Reply context..."></textarea>
                </div>
                <button onclick="generateAIDraft()" id="genBtn" class="w-full bg-green-700 text-white py-4 rounded-xl font-bold hover:bg-green-800 shadow-lg">Generate AI Reply</button>
            </div>
        </div>
    </div>
    <div class="lg:col-span-8 flex flex-col items-center">
        <div class="w-full max-w-[210mm]">
            <div id="letter-preview" class="paper-font text-slate-900">
                <img id="bgTemplate" class="hidden" alt="Letterhead">
               
                <div id="contentArea">
                <div id="bodyText" contenteditable="true" class="text-justify min-h-[400px] mt-6 flex-grow">
                        ‡Æü‡ØÜ‡ÆÆ‡Øç‡Æ™‡Øç‡Æ≥‡Øá‡Æü‡Øç ‡Æ™‡Æ§‡Æø‡Æµ‡Øá‡Æ±‡Øç‡Æ±‡Æø, Groq key ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æø‡Æü‡Øç‡Æü‡ØÅ AI ‡Æâ‡Æ§‡Æµ‡Æø‡ÆØ‡ØÅ‡Æü‡Æ©‡Øç ‡Æ™‡Æ§‡Æø‡Æ≤‡Øç ‡Æâ‡Æ∞‡ØÅ‡Æµ‡Ææ‡Æï‡Øç‡Æï‡Æ≤‡Ææ‡ÆÆ‡Øç.
                    </div>
                   
                 
                    </div>
                </div>
            </div>
           
            <button onclick="downloadPDF()" class="no-print mt-6 mb-10 w-full bg-rose-600 text-white py-4 rounded-xl font-bold shadow-xl hover:bg-rose-700">
                üìÑ Download PDF Letter
            </button>
        </div>
    </div>
</div>
<script>
// UI Controls (unchanged)
document.getElementById('fontSize').oninput = e => {
    document.getElementById('contentArea').style.fontSize = e.target.value + 'pt';
    document.getElementById('fontVal').innerText = e.target.value + 'pt';
};
['topMargin','leftMargin','rightMargin'].forEach(id => {
    const el = document.getElementById(id);
    if(!el) return;
    el.oninput = e => {
        const prop = id==='topMargin'?'paddingTop':(id==='leftMargin'?'paddingLeft':'paddingRight');
        const val = e.target.value + 'mm';
        document.getElementById('contentArea').style[prop] = val;
        document.getElementById(id.replace('Margin','Val')).innerText = val;
    };
});
// Template Handling (unchanged)
document.getElementById('templateInput').onchange = e => {
    const reader = new FileReader();
    reader.onload = ev => {
        const img = document.getElementById('bgTemplate');
        img.src = ev.target.result;
        img.classList.remove('hidden');
    };
    reader.readAsDataURL(e.target.files[0]);
};
// OCR Processing (unchanged)
async function processOCR() {
    const file = document.getElementById('receivedLetterInput').files[0];
    if (!file) return alert("‡Æ™‡Æü‡ÆÆ‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç");
    const btn = document.getElementById('ocrBtn');
    btn.innerText = "Scanning..."; btn.disabled = true;
   
    try {
        const { data: { text } } = await Tesseract.recognize(file, 'tam+eng');
        document.getElementById('userPrompt').value = `Reply to this: \n${text.trim()}`;
        btn.innerText = "‚úÖ Done";
    } catch (e) {
        alert("OCR Error: " + e.message);
    } finally {
        setTimeout(() => { btn.disabled = false; btn.innerText = "Scan & Extract"; }, 2000);
    }
}
// AI Generation (unchanged)
async function generateAIDraft() {
    const key = document.getElementById('groqApiKey').value.trim();
    const prompt = document.getElementById('userPrompt').value.trim();
    if (!key || !prompt) return alert("API Key & Context are required!");
    const body = document.getElementById('bodyText');
    const btn = document.getElementById('genBtn');
   
    body.innerText = "ü§ñ Writing letter...";
    btn.disabled = true;
    try {
        const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${key}`
            },
            body: JSON.stringify({
                model: "llama-3.3-70b-versatile",
                messages: [
                    {
                        role: "system",
                        content: "You are a Tamil Nadu State Government Orders / Letters writer. Write it in 75-200 words to fit on one page."
                    },
                    { role: "user", content: prompt }
                ],
                temperature: 0.5
            })
        });
        const data = await res.json();
        if (data.choices) {
            body.innerText = data.choices[0].message.content.trim();
        } else {
            throw new Error("Invalid API Response");
        }
    } catch (e) {
        body.innerText = "‚ùå Error: " + e.message;
    } finally {
        btn.disabled = false;
    }
}
// Improved PDF Download
function downloadPDF() {
    const element = document.getElementById('letter-preview');

    // Critical fixes: scroll to top + wait for render
    window.scrollTo(0, 0);

    // Small delay for fonts/images to settle
    setTimeout(() => {
        const opt = {
            margin:       0,
            filename:     'AGMHSS_Letter.pdf',
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { 
                scale:          2,                // higher quality
                useCORS:        true,
                logging:        false,
                letterRendering: false,            // better text
                allowTaint:     false,
                windowWidth:    794,              // 210mm @ 96dpi
                windowHeight:   1123,             // 297mm @ 96dpi
                x:              0,
                y:              0
            },
            jsPDF:        { 
                unit:       'mm', 
                format:     'a4', 
                orientation: 'portrait' 
            },
            pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] }  // respect CSS page breaks
        };

        html2pdf().set(opt).from(element).save();
    }, 300);  // 300ms delay ‚Äì adjust to 500 if still issues
}
</script>
</body>
</html>
