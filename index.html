<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Smart Letter Drafter - AGMHSS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tinos:wght@400;700&display=swap');
        .paper-font { font-family: 'Tinos', serif; }
        #letter-preview { width: 210mm; min-height: 297mm; position: relative; }
        @media print { .no-print { display: none; } }
        /* Smooth transition for margin adjustments */
        #contentArea { transition: padding 0.1s ease; }
    </style>
</head>
<body class="bg-slate-200 min-h-screen pb-10">

<div class="no-print bg-indigo-900 text-white p-4 mb-6 shadow-lg flex justify-between items-center px-10">
    <h1 class="text-2xl font-bold">AI Letter Pad SPA</h1>
    <span class="text-sm bg-indigo-800 px-3 py-1 rounded">AGMHSS IT Dept</span>
</div>

<div class="max-w-7xl mx-auto px-4 grid grid-cols-1 lg:grid-cols-12 gap-6">
    
    <div class="lg:col-span-4 space-y-4 no-print">
        <div class="bg-white p-5 rounded-xl shadow-md border-t-4 border-indigo-500">
            <h2 class="font-bold text-lg mb-4">⚙️ Controls & Alignment</h2>
            
            <div class="space-y-5">
                <div>
                    <label class="block text-sm font-semibold text-gray-700">Letterhead Template</label>
                    <input type="file" id="templateInput" accept="image/*" class="mt-1 block w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                </div>

                <div class="p-3 bg-amber-50 rounded-lg border border-amber-200">
                    <label class="block text-sm font-bold text-amber-800 italic">Reply Mode OCR</label>
                    <input type="file" id="receivedLetterInput" accept="image/*" class="mt-1 block w-full text-xs">
                    <button onclick="processOCR()" id="ocrBtn" class="mt-2 w-full bg-amber-600 text-white py-1 rounded text-sm font-bold hover:bg-amber-700">Scan Received Letter</button>
                </div>

                <div class="space-y-3 bg-gray-50 p-3 rounded-lg border border-gray-200">
                    <p class="text-xs font-bold text-gray-500 uppercase tracking-wider">Margin Adjustments (mm)</p>
                    
                    <div>
                        <div class="flex justify-between text-xs mb-1"><span>Top Margin</span><span id="topVal">45mm</span></div>
                        <input type="range" id="topMargin" min="10" max="120" value="45" class="w-full h-1.5 bg-gray-300 rounded-lg appearance-none cursor-pointer accent-indigo-600">
                    </div>

                    <div>
                        <div class="flex justify-between text-xs mb-1"><span>Left Margin</span><span id="leftVal">25mm</span></div>
                        <input type="range" id="leftMargin" min="10" max="60" value="25" class="w-full h-1.5 bg-gray-300 rounded-lg appearance-none cursor-pointer accent-indigo-600">
                    </div>

                    <div>
                        <div class="flex justify-between text-xs mb-1"><span>Right Margin</span><span id="rightVal">20mm</span></div>
                        <input type="range" id="rightMargin" min="10" max="60" value="20" class="w-full h-1.5 bg-gray-300 rounded-lg appearance-none cursor-pointer accent-indigo-600">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700">Purpose / Context</label>
                    <textarea id="userPrompt" rows="3" class="w-full mt-1 border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="e.g. Leave request or Reply context..."></textarea>
                </div>

                <button onclick="generateAIDraft()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 shadow-md">✨ Generate AI Draft</button>
            </div>
        </div>
    </div>

    <div class="lg:col-span-8 flex justify-center">
        <div class="sticky top-4">
            <div id="letter-preview" class="bg-white shadow-2xl overflow-hidden mb-4">
                <img id="bgTemplate" class="absolute top-0 left-0 w-full h-full object-fill z-0 hidden">
                
                <div id="contentArea" class="relative z-10 paper-font text-gray-900 space-y-6 text-[12pt]" style="padding: 45mm 20mm 20mm 25mm;">
                    <div class="text-right">
                        <span contenteditable="true" id="currentDate" class="outline-none border-b border-transparent hover:border-gray-300"></span>
                    </div>
                    
                    <div id="salutation" contenteditable="true" class="font-bold outline-none hover:bg-indigo-50">Respected Sir/Madam,</div>
                    
                    <div id="bodyText" contenteditable="true" class="leading-relaxed text-justify outline-none min-h-[200px] hover:bg-indigo-50">
                        This area is editable. Use the AI tool to draft a response or type directly here. Adjust the sliders on the left to align this text with your letterhead's borders.
                    </div>
                    
                    <div id="closing" class="mt-12">
                        <div id="thanksField" contenteditable="true" class="outline-none hover:bg-indigo-50">Thanking you,</div>
                        <div class="pt-10">
                            <p>Yours faithfully,</p>
                            <p id="signatory" contenteditable="true" class="font-bold mt-4 outline-none hover:bg-indigo-50">[Signature/Designation]</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <button onclick="downloadPDF()" class="no-print mt-6 w-full bg-rose-600 text-white py-4 rounded-xl font-bold shadow-xl hover:bg-rose-700 flex items-center justify-center gap-3 active:scale-95 transition-all">
            Download Final PDF
        </button>
    </div>
</div>
                <script>
    // Initialize Date
    document.getElementById('currentDate').innerText = new Date().toLocaleDateString('en-GB', {
        day: 'numeric', month: 'long', year: 'numeric'
    });

    // 1. Margin Controls Logic
    const content = document.getElementById('contentArea');
    const sliders = {
        top: { el: document.getElementById('topMargin'), val: document.getElementById('topVal'), prop: 'paddingTop' },
        left: { el: document.getElementById('leftMargin'), val: document.getElementById('leftVal'), prop: 'paddingLeft' },
        right: { el: document.getElementById('rightMargin'), val: document.getElementById('rightVal'), prop: 'paddingRight' }
    };

    Object.keys(sliders).forEach(key => {
        sliders[key].el.oninput = function() {
            const val = this.value + "mm";
            content.style[sliders[key].prop] = val;
            sliders[key].val.innerText = val;
        };
    });

    // 2. Template Logic
    document.getElementById('templateInput').onchange = function(e) {
        const reader = new FileReader();
        reader.onload = (event) => {
            const img = document.getElementById('bgTemplate');
            img.src = event.target.result;
            img.classList.remove('hidden');
        };
        reader.readAsDataURL(e.target.files[0]);
    };

    // 3. OCR Logic
    async function processOCR() {
        const file = document.getElementById('receivedLetterInput').files[0];
        if (!file) return alert("Upload a letter first.");
        const btn = document.getElementById('ocrBtn');
        btn.innerText = "⏳ Processing...";
        try {
            const { data: { text } } = await Tesseract.recognize(file, 'eng');
            document.getElementById('userPrompt').value = "REPLY TO: " + text;
            btn.innerText = "✅ Done";
        } catch (e) { alert("OCR Failed"); btn.innerText = "Retry"; }
    }

    // 4. AI Logic (Placeholder)
    async function generateAIDraft() {
        const prompt = document.getElementById('userPrompt').value;
        const body = document.getElementById('bodyText');
        body.innerHTML = "<i>AI Drafting...</i>";
        setTimeout(() => {
            body.innerText = "With regard to the modernization of our computer lab under the Smart School Initiative, we are pleased to submit the detailed project proposal. " + (prompt.includes("REPLY") ? "As requested in your previous communication, we have attached the technical specifications." : "");
            document.getElementById('signatory').innerText = "Rajarajan\nIT In-Charge, AGMHSS";
        }, 1200);
    }

    // 5. PDF Download
    function downloadPDF() {
    const element = document.getElementById('letter-preview');

    // Very important: scroll to top before capture (prevents blank top page)
    window.scrollTo(0, 0);

    const opt = {
        margin:       [0, 0, 0, 0],           // no extra margin around the element
        filename:     'Official_Letter.pdf',
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { 
            scale:          2,                // good balance between quality & performance
            useCORS:        true,
            logging:        false,
            letterRendering: true,
            windowWidth:    794,              // ≈ 210mm @ 96dpi – helps force correct capture width
            windowHeight:   1123,             // ≈ 297mm @ 96dpi
            x:              0,
            y:              0
        },
        jsPDF:        { 
            unit:       'mm', 
            format:     'a4', 
            orientation: 'portrait'
        },
        pagebreak:    { mode: ['avoid-all', 'css'] }   // respect your page-break-* CSS
    };

    html2pdf().set(opt).from(element).save();
}

</script>
</body>
</html>
